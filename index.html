<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen">
  <title>CATastrophe 2</title>
  <!--<link rel="stylesheet" href="assets/css/HUD.css">-->
  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/mobile.css">
  <link rel="stylesheet" href="assets/css/desktopHUD.css">
  <link rel="stylesheet" href="assets/css/modals.css">
  <script type="importmap">
    {
      "imports": {
        "kaplay": "https://cdn.skypack.dev/kaplay"
      }
    }
  </script>
</head>
<body>
<!-- ======================= BACKGROUND =======================-->
<div id="stars"></div>
<div class="dreamy-overlay"></div>

<div class="content-wrapper">
  <div class="background-gradient"></div>
  <div class="waves">
       <svg id="wave1" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,350 Q500,150 1000,350 T2000,350 T3000,350 L3000,600 L0,600 Z" fill="#4b0082" opacity="0.9"/>
        </svg>
        <svg id="wave2" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,380 Q500,200 1000,380 T2000,380 T3000,380 L3000,600 L0,600 Z" fill="#c71585" opacity="0.8"/>
        </svg>
        <svg id="wave5" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,300 Q250,150 500,300 T1000,300 T1500,300 T2000,300 T2500,300 T3000,300 L3000,600 L0,600 Z" fill="#ff69b4" opacity="0.5"/>
        </svg>

  </div>



<!-- ======================= CANVAS =======================-->

  <div id="gameRoot">
    <!-- Canvas will be inserted here by game.js -->
    <canvas id="gameCanvas"></canvas>
  </div>

  <!-- HUD OVERLAY - DESKTOP -->
      <button id="muteBtn" class="muteBtn" aria-label="Mute">
        <img id="muteIcon" src="assets/images/icons/music.png" alt="Music">
      </button>
      <button id="pauseBtn" class="pauseBtn" aria-label="Pause">
        <img src="assets/images/icons/pause.png" alt="Pause">
      </button>

  
  <!-- MOBILE HUD OVERLAY -->
  <div class="mobile-hud-overlay">
    <div class="mobile-hud-top">
      <div id="mobileScore" class="mobile-hud-stat">SCORE: 0</div>
      <div id="mobileHP" class="mobile-hud-stat">HP: 100</div>
      <div id="mobileLives" class="mobile-hud-stat">LIVES: 3</div>
      <div id="mobileTime" class="mobile-hud-stat">TIME: 1:30</div>
    </div>
    <div class="mobile-hud-controls">
      <button id="mobileVolumeBtn" class="mobile-hud-btn"><img id="muteIcon" src="assets/images/icons/music.png" alt="Music"></button>
      <button id="mobilePauseBtn" class="mobile-hud-btn"><img src="assets/images/icons/pause.png" alt="Pause"></button>
    </div>
  </div>
<!-- ==================== BUTTONS ========================== -->
<!-- BOSS FINISH HIM BUTTON  -->
<div id="finishHimButton" class="hidden">
  <div class="finish-him-container">
    <button class="finish-him-button" id="finishHimBtn">
            <div class="finish-him-button-text" id="finishHimBtnText">Use Special Attack</div>
    </button>
    </div>
</div>




<!-- ========================= DEBUG STUFF ===================== 
<div class="debug-toggle" id="debugToggle" title="Toggle Debug Info">
    <img src="assets/images/settings.png" alt="Settings">
</div>

<div class="debug-info" id="debugInfo" style="display: none;">
    X: 0  Y: 0
</div>
</div>-->

<!-- ======================= MODAlS =======================-->

<div id="startScreenModal" class="start-screen-modal">
  <div class="start-screen-modal__inner">
    <button id="startDesktopBtn"  class="start-screen-modal__btn">PLAY ON PC</button>
    <button id="startMobileBtn"   class="start-screen-modal__btn">PLAY ON MOBILE</button>
    <p class="start-screen-modal__hint">Keyboard: Press 1 for PC  |  Press 2 for Mobile</p>
  </div>
</div>

<!-- MAIN MENU MODAL -->
<div id="mainMenuModal" class="modal">
  <div class="modal-mainmenu-content">
    <div class="modal-mainmenu-header">
      <img src="./assets/images/title.PNG" alt="CATastrophe 2" class="menu-title-img">
    </div>
    <div class="modal-body">
      <div class="button-column">
        <button class="modal-button-menu-play" id="playModalBtn">
          PLAY
        </button>
        
        <button class="modal-button-menu-how" id="howToPlayModalBtn">
          HOW TO PLAY
        </button>

      </div>
    </div>
  </div>
</div>

<div id="howToPlayModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title">HOW TO PLAY</h1>
      <button class="modal-close" id="howToPlayModal">X</button>
    </div>
    <div class="modal-body">
          <blockquote>
            <p><em>"Nature has no reverence towards life. Nature treats life as though it were the most valueless thing in the world....<br>
            Nature does not act by purposes."</em><br>
            <cite>‚Äî Erwin Schr√∂dinger</cite></p>
          </blockquote>         
          <h1> Welcome to Schr√∂dinger's Cat Caf√©! </h3>
          <p>The caf√© is in a state of suPURRRposition ‚Äî simultaneously fine and <em>very much not fine</em>. </p>
          <p>The vibe is off. The <strong>Entanglement Index</strong> has spiked off the charts. And the sass levels are dangerously high. </p>
          <p>
          Cups are behaving‚Ä¶ <em>purrculiarly</em>.<br>
          Cucumbers are falling from the ceiling.<br>
          Rats have clawed their way into the usually rodent-free caf√©.<br>
          And the laser pointers?<br>
          Not the fun kind. The <strong>ouch</strong> kind.
          </p>

          <p>
          Someone‚Äîor <strong>something</strong>‚Äîis paw-sibly meddling with the quantum balance.
          </p>

          <p><strong>Your mission:</strong> Stretch your toe beans, sharpen those claws. Grab the catnip. And help the cats collapse the wavefunction in the right direction and save the caf√© from becoming... unalive. </p>

          <hr>

          <h2>üéÆ How to Play</h2>
            <h3>Levels</h3>
            <ul>
              <li><strong>‚Üê / ‚Üí Arrow Keys</strong> ‚Äî Move</li>
              <li><strong>Spacebar</strong> ‚Äî Jump</li>
            </ul>
            <p>Knock cups off tables (as cats do), keep an eye out for helpful items, avoid (or stomp!) enemies, and reach the Cat Tower to finish the level.</p>
            <p>  Some levels may hide <strong>secret rooms</strong>‚Äîbecause curious cats don‚Äôt always get caught‚Ä¶ üëÄ</p>

          <h3>‚öîÔ∏è Boss Battles ‚öîÔ∏è</h3>

            <p>  When things get hiss-terical, boss fights switch to <strong>turn-based</strong> battle style. </p>
            <ul>
              <li>Click the move you want to use each turn</li>
              <li>You and the boss take turns attacking</li>
              <li>Your <strong>Speed</strong> stat determines who acts first ‚Äî because even in quantum combat, fast paws win fights.</li>
              <li>Reduce the boss‚Äôs HP to <strong>0</strong> to win</li>
              <li>If your HP reaches <strong>0</strong>, it‚Äôs nap time‚Ä¶ permanently</li>
            </ul>

            <p>  Choose your moves wisely‚Äîthis is no time to paws around üòº  </p>
            <p>  <em>The wave function won‚Äôt collapse itself‚Ä¶ probably.</em>  </p>
            <p>  <em>After all‚Ä¶ observation changes everything.</em>  </p>

            <p class="mission-text"><strong>Good luck, brave cat warrior!</strong><br> The fate of Schr√∂dinger's Cat Caf√© is now in your <em>toe beans</em>! üêæ</p>

    </div>
  </div>
</div>

<!-- LEAVING OFF THE GAME FOR NOW BUT KEEPING HERE BECAUSE I AM GOING TO ADD IT EVENTUALLY-->
<!--<div id="aboutCatsModal" class="modal"> 
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title">MEET THE CATS</h1>
        <button class="modal-close" id="closeCatsModal">X</button>
      </div>
      <div class="modal-body">
        <div class="cat-grid">
          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="./assets/images/portraits/Nona.png" alt="Nona">
                <h3>NONA</h3>
              </div>
              <div class="cat-card-back">
                <h3>NONA</h3>
                <p>PLACEHOLDER ‚ô•</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="./assets/images/portraits/Gato.png" alt="Gato">
                <h3>GATO</h3>
              </div>
              <div class="cat-card-back">
                <h3>GATO</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="./assets/images/portraits/Nova.png" alt="Nova">
                <h3>NOVA</h3>
              </div>
              <div class="cat-card-back">
                <h3>NOVA</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="./assets/images/portraits/Niels.png" alt="Niels">
                <h3>NIELS</h3>
              </div>
              <div class="cat-card-back">
                <h3>NIELS</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="./assets/images/portraits/Aubie.png" alt="Aubie">
                <h3>AUBIE</h3>
              </div>
              <div class="cat-card-back">
                <h3>AUBIE</h3>
                <p>PLACEHOLDER. War Eagle! ü¶Ö</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="./assets/images/portraits/Doug.png" alt="Doug">
                <h3>DOUG</h3>
              </div>
              <div class="cat-card-back">
                <h3>DOUG</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>-->

<div id="charSelectModal" class="modal">
  <div class="modal-charselect-content">
    <!-- Left panel: Character grid -->
    <div class="charselect-left">
      <h2 class="panel-title">SPECIALS</h2>
      <div id="characterGrid" class="character-grid">
        <!-- Cards built dynamically in JS -->
      </div>
      <button class="modal-button" id="backToMenuBtn">BACK</button>

    </div>
    
    <div class="charselect-right">
      <div class="stats-panel">
        <h2 class="panel-title">STATS</h2>
        <div id="statsDisplay" class="stats-list">
          <div class="select-stat-row"><span>HP</span><span id="statHP">--</span></div>
          <div class="select-stat-row"><span>ATK</span><span id="statATK">--</span></div>
          <div class="select-stat-row"><span>DEF</span><span id="statDEF">--</span></div>
          <div class="select-stat-row"><span>SPD</span><span id="statSPD">--</span></div>
        </div>
      </div>
      

      <button class="modal-button" id="confirmCharBtn" disabled>CONTINUE </button>
    
    </div>
          <div class="preview-panel">

        <h3 id="charName">CHOOSE YOUR FELINE FIGHTER</h3>
      </div>

  </div>

</div>

<div id="newMoveModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title"> üîì NEW BATTLE MOVE UNLOCKED! üîì </h1>
    </div>
    <div class="modal-body">
      <div class="unlock">
        <h1 id="moveName">WHISKER WHIP!</h1>
        <h2 id="moveStats">(DMG: 40, Uses: 2)</h2>
        <img id="moveImage" src="./assets/images/items/whiskerWhip.PNG" alt="WHISKER WHIP" style="display: block; margin: 20px auto; max-width: 200px; filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));">
        <h3>Select a move to replace:</h3>
        
        <div class="move-container">
          <div class="move-grid" id="moveButtonsContainer">
          </div>
        </div>
        
        <button class="modal-button" id="confirmMoveBtn" disabled style="opacity: 0.5;">CONFIRM</button>
      </div>
    </div>
  </div>
</div>

<div id="fragmentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title">YOU'RE ON üî• RIGHT MEOW!</h1>
    </div>
    <div class="modal-body">
      <div class="unlock">
        <div class="fragment-progress" style="text-align: center; margin: 30px 0;">
          <h1 id="fragmentCount" style="font-size: 2rem; color: var(--ParticlePink); margin: 20px 0;">1/3 electron states collected!</h1>
          <div class="fragment-icons" style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
            <div class="fragment-icon" id="fragment1" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9090c0; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-family: 'SpaceLetters'; transition: all 0.3s;">üí´</div>
            <div class="fragment-icon" id="fragment2" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9090c0; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-family: 'SpaceLetters'; transition: all 0.3s;">üí´</div>
            <div class="fragment-icon" id="fragment3" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9090c0; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-family: 'SpaceLetters'; transition: all 0.3s;">üí´</div>
          </div>
        </div>
        <button class="modal-button" id="continueFragmentBtn">CONTINUE</button>
      </div>
    </div>
  </div>
</div>


<div id="upgradeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title">üí• THAT WAS SUPURRRRR!! üí•</h1>
    </div>
    <div class="modal-body">
      <div class="unlock">
        <h3 id="upgradeInstructions" style="margin-bottom: 10px;">You can meow select a stat to increase by 1 point!</h3>
        <div style="display: flex; gap: 30px; align-items: center; justify-content: center; flex-wrap: wrap;">
          
          <div class="stats-card" style="flex: 0 1 400px; margin: 0;">
            <div class="stats-content">
              <div class="stats-title">CURRENT STATS:</div>
              
              <div class="stat-row" id="attackRow">
                <span class="stat-label">Attack</span>
                <span class="stat-value" id="attackValue">0</span>
              </div>
              
              <div class="stat-row" id="defenseRow">
                <span class="stat-label">Defense</span>
                <span class="stat-value" id="defenseValue">0</span>
              </div>
              
              <div class="stat-row" id="speedRow">
                <span class="stat-label">Speed</span>
                <span class="stat-value" id="speedValue">0</span>
              </div>
            </div>
          </div>

          <div style="flex: 0 1 280px; display: flex; flex-direction: column; gap: 10px;">
            <!-- ATTACK -->
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
              <button class="modal-button" id="attackDecBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; opacity: 0.3; flex-shrink: 0;" disabled>‚àí</button>
              <div style="text-align: center; min-width: 120px;">
                <strong style="font-family: 'Orbitron', monospace; font-size: 1rem; color: #67FEBD; display: block;">ATTACK</strong>
                <span style="font-size: 1.2rem; color: #dbe2e9;">+<span id="attackIncrease">0</span></span>
              </div>
              <button class="modal-button" id="attackIncBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; flex-shrink: 0;">+</button>
            </div>

            <!-- DEFENSE -->
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
              <button class="modal-button" id="defenseDecBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; opacity: 0.3; flex-shrink: 0;" disabled>‚àí</button>
              <div style="text-align: center; min-width: 120px;">
                <strong style="font-family: 'Orbitron', monospace; font-size: 1rem; color: #ff69b4; display: block;">DEFENSE</strong>
                <span style="font-size: 1.2rem; color: #dbe2e9; ">+<span id="defenseIncrease">0</span></span>
              </div>
              <button class="modal-button" id="defenseIncBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; flex-shrink: 0;">+</button>
            </div>

            <!-- SPEED -->
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
              <button class="modal-button" id="speedDecBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; opacity: 0.3; flex-shrink: 0;" disabled>‚àí</button>
              <div style="text-align: center; min-width: 120px;">
                <strong style="font-family: 'Orbitron', monospace; font-size: 1rem; color: #A55AFF; display: block;">SPEED</strong>
                <span style="font-size: 1.2rem; color: #dbe2e9; ">+<span id="speedIncrease">0</span></span>
              </div>
              <button class="modal-button" id="speedIncBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; flex-shrink: 0;">+</button>
            </div>
          </div>
        </div>

        <div style="font-family: 'GothNerd', sans-serif; font-size: 1.2rem; color: #dbe2e9; text-align: center; margin: 15px 0 20px 0; padding: 5px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 2px solid #9090c0;" id="pointsRemaining">
          Points Remaining: <span style="color: #ff6bff; font-weight: 700; font-size: 1.5rem;" id="pointsValue">1</span>
        </div>
        
        <button class="modal-button" id="confirmUpgradeBtn" disabled style="opacity: 0.5;">CONFIRM</button>
      </div>
    </div>
  </div>
</div>

<!-- GAME OVER MODAL -->
<div id="gameOverModal" class="modal">
  <div class="modal-gameover-content">
    <div class="modal-gameover-header">
      <h1 class="modal-title-gameover">GAME OVER</h1>
    </div>
    <div class="modal-body">
      <p class="disappointment-text">YOU'VE DISAPPOINTED EVERYONE</p>
      <p id="gameOverScoreText" class="score-text">Final Score: --</p>
      

        <button class="modal-button-gameover" id="gameOverBackBtn">
          BACK TO MENU
        </button>

    </div>
  </div>
</div>

<!-- YOU DIED MODAL -->
<div id="youDiedModal" class="modal">
  <div class="modal-youdied-content">
    <div class="modal-youdied-header">
      <h1 class="modal-title-youdied">YOU DIED</h1>
    </div>
    <div class="modal-body">
      <p class="encourage-text">Sharpen those claws and get back out there!</p>
        <p id="youDiedScoreText" class="stat-line">Score: --</p>
        <p id="youDiedLivesText" class="stat-line">Lives Left: --</p>
    </div>

      <div class="modal-buttons-YouDied">
            <button class="modal-button-died" id="useLifeModalBtn">
          USE LIFE
        </button>
        <button class="modal-button-died" id="quitToMenuModalBtn">
          QUIT TO MENU
        </button>
      </div>

  </div>
</div>

<!-- PAUSE MODAL -->
<div id="pauseModal" class="modal">
  <div class="modal-pause-content">
    <div class="modal-pause-header">
      <h1 class="modal-title-pause">PAWSed</h1>
    </div>
    <div class="modal-body">
        <div class="pause-buttons">
        <button class="modal-button" id="pauseResumeModalBtn">
          RESUME
        </button>
        <button class="modal-button" id="pauseQuitModalBtn">
          QUIT TO MENU
        </button>
        </div>
    </div>
  </div>
</div>

<!-- ======================= BOSS BATTLES =======================-->
<!--
<div id="battleUI" class="battle-ui hidden">
  <div class="battle-hp-panel battle-hp-panel--boss" id="bossHPPanel">
    <div class="battle-hp-panel__name" id="bossName">Boss Name</div>
    <div class="battle-hp-panel__row">
      <span class="battle-hp-panel__label">HP:</span>
      <div class="battle-hp-panel__bar-track">
        <div class="battle-hp-panel__bar-fill" id="bossHPBarFill" style="width: 100%;"></div>
      </div>
      <span class="battle-hp-panel__text" id="bossHPText">100 / 100</span>
    </div>
  </div>

  <div class="battle-hp-panel battle-hp-panel--player" id="playerHPPanel">
    <div class="battle-hp-panel__name" id="playerName">Player Name</div>
    <div class="battle-hp-panel__row">
      <span class="battle-hp-panel__label">HP:</span>
      <div class="battle-hp-panel__bar-track">
        <div class="battle-hp-panel__bar-fill" id="playerHPBarFill" style="width: 100%;"></div>
      </div>
      <span class="battle-hp-panel__text" id="playerHPText">100 / 100</span>
    </div>
  </div>

  <div class="battle-bottom-bar" id="battleBottomBar">

    <div class="battle-log" id="battleLogPanel">
      <div class="battle-log__text" id="battleLogText">...</div>
    </div>

    <div class="battle-moves" id="moveButtonsPanel">
      <button class="battle-move-btn" id="moveBtn0" data-index="0">Move 1</button>
      <button class="battle-move-btn" id="moveBtn1" data-index="1">Move 2</button>
      <button class="battle-move-btn" id="moveBtn2" data-index="2">Move 3</button>
      <button class="battle-move-btn" id="moveBtn3" data-index="3">Move 4</button>
    </div>

  </div>
</div>-->

<!-- ======================= SCRIPTS =======================-->
<script type="module" src="modules/game.js"></script>   

<script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>
  

 <!-- ===== MODAL CONTROLLER =====-->
<script>
class UpgradeModalController {
  constructor() {
    this.callbacks = {};
    this.tempStats = { attack: 0, defense: 0, speed: 0 };
    this.remainingPoints = 0;
    this.totalPoints = 0; 
    this.selectedMove = null;
    
    this.initializeEventListeners();
  }

  initializeEventListeners() {
    document.getElementById('closeNewMoveModal')?.addEventListener('click', () => this.closeModal('newMoveModal'));
    document.getElementById('closeFragmentModal')?.addEventListener('click', () => this.closeModal('fragmentModal'));
    document.getElementById('closeUpgradeModal')?.addEventListener('click', () => this.closeModal('upgradeModal'));

    document.getElementById('attackIncBtn')?.addEventListener('click', () => this.incrementStat('attack'));
    document.getElementById('defenseIncBtn')?.addEventListener('click', () => this.incrementStat('defense'));
    document.getElementById('speedIncBtn')?.addEventListener('click', () => this.incrementStat('speed'));

    document.getElementById('attackDecBtn')?.addEventListener('click', () => this.decrementStat('attack'));
    document.getElementById('defenseDecBtn')?.addEventListener('click', () => this.decrementStat('defense'));
    document.getElementById('speedDecBtn')?.addEventListener('click', () => this.decrementStat('speed'));

    document.getElementById('confirmUpgradeBtn')?.addEventListener('click', () => this.confirmStatsUpgrade());
    document.getElementById('continueFragmentBtn')?.addEventListener('click', () => this.continueFromFragment());
    document.getElementById('confirmMoveBtn')?.addEventListener('click', () => this.confirmMoveSwap());

    ['newMoveModal', 'fragmentModal', 'upgradeModal'].forEach(modalId => {
      document.getElementById(modalId)?.addEventListener('click', (e) => {
        if (e.target.id === modalId) this.closeModal(modalId);
      });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (document.getElementById('newMoveModal').style.display === 'flex') {
          this.closeModal('newMoveModal');
        } else if (document.getElementById('fragmentModal').style.display === 'flex') {
          this.closeModal('fragmentModal');
        } else if (document.getElementById('upgradeModal').style.display === 'flex') {
          this.closeModal('upgradeModal');
        }
      }
    });
  }

  // ==================== STATS UPGRADE MODAL ====================
  openStatsUpgrade(statPoints, currentStats, onComplete) {
    console.log('üìà Opening stats upgrade modal:', { statPoints, currentStats });
    
    this.totalPoints = statPoints;
    this.remainingPoints = statPoints;
    this.tempStats = { attack: 0, defense: 0, speed: 0 };
    this.baseStats = { ...currentStats }; 
    this.callbacks.statsComplete = onComplete;

    document.getElementById('upgradeInstructions').textContent = 
      `You can meow select a stat to increase by ${statPoints} point${statPoints > 1 ? 's' : ''}!`;
    
    document.getElementById('attackValue').textContent = currentStats.attack || 0;
    document.getElementById('defenseValue').textContent = currentStats.defense || 0;
    document.getElementById('speedValue').textContent = currentStats.speed || 0;
    
    console.log('üìä Displaying current stats:', currentStats);
    
    document.getElementById('pointsValue').textContent = this.remainingPoints;
    document.getElementById('attackIncrease').textContent = 0;
    document.getElementById('defenseIncrease').textContent = 0;
    document.getElementById('speedIncrease').textContent = 0;
    
    this.updateButtonStates();
    
    const confirmBtn = document.getElementById('confirmUpgradeBtn');
    confirmBtn.disabled = true;
    confirmBtn.style.opacity = '0.5';

    this.showModal('upgradeModal');
  }

  incrementStat(stat) {
    if (this.remainingPoints <= 0) return;

    this.tempStats[stat]++;
    this.remainingPoints--;

    this.updateStatDisplay(stat);
    this.updateButtonStates();

    if (window.play) window.play("extraLife", { volume: 0.2 });
  }

  decrementStat(stat) {
    if (this.tempStats[stat] <= 0) return;

    this.tempStats[stat]--;
    this.remainingPoints++;

    this.updateStatDisplay(stat);
    this.updateButtonStates();

    if (window.play) window.play("happyMeow", { volume: 0.15 });
  }

  updateStatDisplay(stat) {
    document.getElementById(`${stat}Increase`).textContent = this.tempStats[stat];
    
    document.getElementById('pointsValue').textContent = this.remainingPoints;

    const statMultiplier = 1;
    const newStatValue = this.baseStats[stat] + (this.tempStats[stat] * statMultiplier);
    document.getElementById(`${stat}Value`).textContent = newStatValue;

    const row = document.getElementById(`${stat}Row`);
    row.classList.add('increase');
    setTimeout(() => row.classList.remove('increase'), 500);
  }

  updateButtonStates() {
    const canIncrement = this.remainingPoints > 0;
    ['attack', 'defense', 'speed'].forEach(stat => {
      const incBtn = document.getElementById(`${stat}IncBtn`);
      if (incBtn) {
        incBtn.disabled = !canIncrement;
        incBtn.style.opacity = canIncrement ? '1' : '0.3';
        incBtn.style.cursor = canIncrement ? 'pointer' : 'not-allowed';
      }
    });

    ['attack', 'defense', 'speed'].forEach(stat => {
      const decBtn = document.getElementById(`${stat}DecBtn`);
      const canDecrement = this.tempStats[stat] > 0;
      if (decBtn) {
        decBtn.disabled = !canDecrement;
        decBtn.style.opacity = canDecrement ? '1' : '0.3';
        decBtn.style.cursor = canDecrement ? 'pointer' : 'not-allowed';
      }
    });

    const confirmBtn = document.getElementById('confirmUpgradeBtn');
    if (this.remainingPoints === 0) {
      confirmBtn.disabled = false;
      confirmBtn.style.opacity = '1';
    } else {
      confirmBtn.disabled = true;
      confirmBtn.style.opacity = '0.5';
    }
  }

  confirmStatsUpgrade() {
    if (this.remainingPoints !== 0) return;

    console.log('‚úÖ Stats upgrade confirmed:', this.tempStats);
    
    if (window.play) window.play("powerUp", { volume: 0.4 });
    
    this.closeModal('upgradeModal');
    
    setTimeout(() => {
      const canvas = document.querySelector('canvas');
      if (canvas) {
        canvas.focus();
        console.log('‚úÖ Canvas refocused after stats upgrade');
      }
    }, 100);
    
    if (this.callbacks.statsComplete) {
      this.callbacks.statsComplete(this.tempStats);
    }
  }

  // ==================== FRAGMENT COLLECTION MODAL ====================
  openFragmentCollection(fragmentsCollected, onComplete) {
    console.log('‚ú® Opening fragment collection modal:', fragmentsCollected);
    
    this.callbacks.fragmentComplete = onComplete;

    document.getElementById('fragmentCount').textContent = `${fragmentsCollected}/3 fragments obtained`;
    
    for (let i = 1; i <= 3; i++) {
      const fragment = document.getElementById(`fragment${i}`);
      if (i <= fragmentsCollected) {
        setTimeout(() => {
          fragment.classList.add('collected');
        }, i * 200); 
      } else {
        fragment.classList.remove('collected');
      }
    }

    this.showModal('fragmentModal');
  }

  continueFromFragment() {
    if (window.play) window.play("powerUp", { volume: 0.4 });
    
    this.closeModal('fragmentModal');
    
    setTimeout(() => {
      const canvas = document.querySelector('canvas');
      if (canvas) {
        canvas.focus();
        console.log('‚úÖ Canvas refocused after fragment collection');
      }
    }, 100);
    
    if (this.callbacks.fragmentComplete) {
      this.callbacks.fragmentComplete();
    }
  }

  // ==================== NEW MOVE MODAL ====================
  openMoveSelection(moveName, moveStats, moveImage, currentMoves, onComplete) {
    console.log('üéØ Opening move selection modal:', { moveName, currentMoves });
    
    this.selectedMove = null;
    this.callbacks.moveComplete = onComplete;

    document.getElementById('moveName').textContent = moveName;
    document.getElementById('moveStats').textContent = moveStats;
    document.getElementById('moveImage').src = moveImage;
    
    const container = document.getElementById('moveButtonsContainer');
    container.innerHTML = '';
    
    Object.entries(currentMoves).forEach(([name, move]) => {
      const btn = document.createElement('button');
      btn.className = 'cyber-button grey-btn cool';
      btn.innerHTML = `<strong>${name}</strong><br>${move.dmg ? `DMG: ${move.dmg}` : `HEAL: ${move.heal}`}`;
      
      btn.addEventListener('click', () => {
        container.querySelectorAll('.cyber-button').forEach(b => b.classList.remove('selected'));
        
        btn.classList.add('selected');
        this.selectedMove = name;
        
        const confirmBtn = document.getElementById('confirmMoveBtn');
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
        
        if (window.play) window.play("happyMeow", { volume: 0.2 });
      });
      
      container.appendChild(btn);
    });

    const confirmBtn = document.getElementById('confirmMoveBtn');
    confirmBtn.disabled = true;
    confirmBtn.style.opacity = '0.5';

    this.showModal('newMoveModal');
  }

  confirmMoveSwap() {
    if (!this.selectedMove) return;

    console.log('‚úÖ Move swap confirmed:', this.selectedMove);
    
    if (window.play) window.play("powerUp", { volume: 0.4 });
    
    this.closeModal('newMoveModal');
    
    setTimeout(() => {
      const canvas = document.querySelector('canvas');
      if (canvas) {
        canvas.focus();
        console.log('‚úÖ Canvas refocused after move swap');
      }
    }, 100);
    
    if (this.callbacks.moveComplete) {
      this.callbacks.moveComplete(this.selectedMove);
    }
  }

  // ==================== UTILITY METHODS ====================
  showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
  }

  closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  }
}

window.upgradeModalController = new UpgradeModalController();

window.openStatsUpgradeModal = (statPoints, currentStats, onComplete) => {
  window.upgradeModalController.openStatsUpgrade(statPoints, currentStats, onComplete);
};

window.openFragmentCollectionModal = (fragmentsCollected, onComplete) => {
  window.upgradeModalController.openFragmentCollection(fragmentsCollected, onComplete);
};

window.openMoveSelectionModal = (moveName, moveStats, moveImage, currentMoves, onComplete) => {
  window.upgradeModalController.openMoveSelection(moveName, moveStats, moveImage, currentMoves, onComplete);
};

console.log('üéÆ Upgrade Modal Controller initialized!');
</script>

</body>
</html>