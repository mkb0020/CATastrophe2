<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="stylesheet" href="/assets/css/basic.css">
  <link rel="stylesheet" href="/assets/css/modals.css">
  <link rel="stylesheet" href="/assets/css/nav.css">
  <link rel="stylesheet" href="/assets/css/dreamy.css">
  <link rel="stylesheet" href="/assets/css/canvas.css">
  <link rel="stylesheet" href="/assets/css/HUD.css">
  <link rel="stylesheet" href="/assets/css/gameButtons.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <script type="importmap">
    {
      "imports": {
        "kaplay": "https://cdn.skypack.dev/kaplay"
      }
    }
  </script>
  <title>CATastrophe2</title>
</head>

<body>
<!-- ======================= BACKGROUND =======================-->
<div id="stars"></div>
<div class="dreamy-overlay"></div>

<div class="content-wrapper">
  <div class="background-gradient"></div>
  <div class="waves">
       <svg id="wave1" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,350 Q500,150 1000,350 T2000,350 T3000,350 L3000,600 L0,600 Z" fill="#4b0082" opacity="0.9"/>
        </svg>
        <svg id="wave2" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,380 Q500,200 1000,380 T2000,380 T3000,380 L3000,600 L0,600 Z" fill="#c71585" opacity="0.8"/>
        </svg>
        <svg id="wave5" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,300 Q250,150 500,300 T1000,300 T1500,300 T2000,300 T2500,300 T3000,300 L3000,600 L0,600 Z" fill="#ff69b4" opacity="0.5"/>
        </svg>

  </div>

<!-- ======================= NAV =======================-->
  <nav class="navbar">
      <div class="nav-container">
        
        <div class="left-dropdown"><!-- LEFT DROPDOWN MENU -->
          <button class="menu-trigger" aria-label="Menu">
            <img src="/assets/images/Niels2.png" alt="Menu" class="home-icon">
          </button>

          <div class="left-menu">
            <a href="https://mkb0020.vercel.app/" class="menu-item">Home</a>
            <a href="https://mkb0020.github.io/n3wton.html" class="menu-item">N3wton's Battle Stats Balancer</a>
            <a href="https://mkb0020.vercel.app/game-testing" class="menu-item">CATastrophe 2 Feedback</a>

            <div class="social-links">
              <a href="https://www.youtube.com/@mkb0020" target="_blank" aria-label="YouTube">
                <img src="/assets/images/icons/youtube-icon.png" alt="YouTube" class="social-icon">
              </a>
            
              <a href="https://www.linkedin.com/in/mkb0020/" target="_blank" aria-label="LinkedIn">
                <img src="/assets/images/icons/linkedin-icon.png" alt="LinkedIn" class="social-icon">
              </a>

              <a href="https://mkb0020.github.io/MKLambda.html" target="_blank" aria-label="Github">
                <img src="/assets/images/icons/music-icon.png" alt="Github" class="social-icon">
              </a>

              <a href="https://github.com/mkb0020" target="_blank" aria-label="GitHub">
                <img src="/assets/images/icons/github-icon.png" alt="GitHub" class="social-icon">
              </a>

              <a href="https://mkb0020.itch.io" target="_blank" aria-label="Itch.io">
                <img src="/assets/images/icons/itchio-icon.png" alt="Itch.io" class="social-icon">
              </a>
            </div>
          </div>
        </div>
<div class="hud-stats-inner">
      <div class="stat-divider">
                |
        </div>
      <div class="stat-item stat-score">
        <span id="scoreText">Score: --</span>
      </div>
      <div class="stat-divider">
                |
      </div>
      <div class="stat-item stat-hp" id="hpStat">
        <span id="hpText">HP: --</span>
      </div>
      <div class="stat-divider">
                |
      </div>
      <div class="stat-item stat-title">
              üê± CATastrophe2 üê± 
      </div>
      <div class="stat-divider">
                |
      </div>
      <div class="stat-item stat-lives">
        <span id="livesText">Lives: --</span>
      </div>
      <div class="stat-divider">
                |
      </div>
      <div class="stat-item stat-time" id="timeStat">
        <span id="timeText">Time: --</span>
      </div>
      <div class="stat-divider">
                |
      </div>

</div>
      <!--<div class="help-dropdown">
        <button class="help-icon" id="helpBtn"><div class="question-mark">?</div></button>
        <div class="dropdown-menu">
          <button id="openHelp">About This Player</button>
        </div>
      </div>-->
      <div class="help-dropdown">
            <div id="game-controls">
                        <button id="volume-btn" class="control-btn" data-tooltip="TURN MUSIC OFF/ON">
                            üîä
                        </button>
                        <button id="pause-btn" class="control-btn" data-tooltip="PAUSE LEVEL">
                            <div class="pause-icon">
                                <div class="pause-bar"></div>
                                <div class="pause-bar"></div>
                            </div>
                        </button>
                    </div>
            </div>
      </div>
    </div>
  </nav>

<!-- ======================= CANVAS =======================-->

<div class="hero-content">
      <div class="canvas-container">
        <canvas id="gameCanvas" width="1000" height="480"></canvas>
      </div>
</div>




<!-- ==================== BUTTONS ========================== -->
<!-- MAIN MENU BUTTONS -->
<div id="mainMenuButtons" class="hidden">
    <button class="game-btn play-btn-container" id="playBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text">PLAY</div>
        </div>
    </button>

    <button class="game-btn standard-btn-container how-to-play" id="howToPlayBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text">How to Play</div>
        </div>
    </button>

    <!--<button class="game-btn standard-btn-container meet-cats" id="meetCatsBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text">Meet the Cats</div>
        </div>
    </button>-->
</div>

<!-- CHARACTER SELECT BUTTONS -->
<div id="charSelectButtons" class="hidden">
    <button class="game-btn back-btn-container" id="charSelectBackBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text">Back</div>
        </div>
    </button>

    <button class="game-btn confirm-btn-container disabled" id="confirmCharBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text">Place Order</div>
        </div>
    </button>
</div>

<!-- GAME OVER BUTTONS -->
<div id="gameOverButtons" class="hidden">
    <button class="game-btn gameover-btn-container menu-btn" id="gameOverMenuBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text">Main Menu</div>
        </div>
    </button>
</div>

<!-- YOU DIED BUTTONS -->
<div id="youDiedButtons" class="hidden">
    <button class="game-btn you-died-btn-container use-life-btn" id="useLifeBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text">Use Life</div>
        </div>
    </button>

    <button class="game-btn you-died-btn-container quit-btn" id="quitToMenuBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text">Quit to Menu</div>
        </div>
    </button>
</div>

<!-- BOSS FINISH HIM BUTTON  -->
<div id="finishHimButton" class="hidden">
    <button class="game-btn finish-him-container" id="finishHimBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text" id="finishHimBtnText">Use Special Attack</div>
        </div>
    </button>
</div>

<!-- LEVEL COMPLETE CONTINUE BUTTON-->
<div id="levelCompleteButton" class="hidden">
    <button class="game-btn level-complete-container" id="levelContinueBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text">Continue</div>
        </div>
    </button>
</div>

<!-- PAUSE MENU BUTTONS -->
<div id="pauseMenuButtons" class="hidden">
    <button class="game-btn pause-resume-btn-container" id="pauseResumeBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text">RESUME</div>
        </div>
    </button>

    <button class="game-btn pause-quit-btn-container" id="pauseQuitBtn">
        <div class="cyber-btn-base">
            <div class="cyber-btn-shine"></div>
            <div class="cyber-btn-text">QUIT</div>
        </div>
    </button>
</div>

<!-- ========================= DEBUG STUFF ===================== -->
<div class="debug-toggle" id="debugToggle" title="Toggle Debug Info">
    <img src="assets/images/settings.png" alt="Settings">
</div>

<div class="debug-info" id="debugInfo" style="display: none;">
    X: 0  Y: 0
</div>
</div>

<!-- ======================= MODAlS =======================-->
<div id="howToPlayModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title">HOW TO PLAY</h1>
      <button class="modal-close" id="howToPlayModal">X</button>
    </div>
    <div class="modal-body">
        PLACEHOLDER

    </div>
  </div>
</div>

<div id="aboutCatsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title">MEET THE CATS</h1>
        <button class="modal-close" id="closeCatsModal">X</button>
      </div>
      <div class="modal-body">
        <div class="cat-grid">
          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Nona.png" alt="Nona">
                <h3>NONA</h3>
              </div>
              <div class="cat-card-back">
                <h3>NONA</h3>
                <p>PLACEHOLDER ‚ô•</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Gato.png" alt="Gato">
                <h3>GATO</h3>
              </div>
              <div class="cat-card-back">
                <h3>GATO</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Nova.png" alt="Nova">
                <h3>NOVA</h3>
              </div>
              <div class="cat-card-back">
                <h3>NOVA</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Niels.png" alt="Niels">
                <h3>NIELS</h3>
              </div>
              <div class="cat-card-back">
                <h3>NIELS</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Aubie.png" alt="Aubie">
                <h3>AUBIE</h3>
              </div>
              <div class="cat-card-back">
                <h3>AUBIE</h3>
                <p>PLACEHOLDER. War Eagle! ü¶Ö</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Doug.png" alt="Doug">
                <h3>DOUG</h3>
              </div>
              <div class="cat-card-back">
                <h3>DOUG</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<div id="newMoveModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title"> üîì NEW BATTLE MOVE UNLOCKED! üîì </h1>
    </div>
    <div class="modal-body">
      <div class="unlock">
        <h1 id="moveName">WHISKER WHIP!</h1>
        <h2 id="moveStats">(DMG: 40, Uses: 2)</h2>
        <img id="moveImage" src="../assets/images/items/whiskerWhip.PNG" alt="WHISKER WHIP" style="display: block; margin: 20px auto; max-width: 200px; filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));">
        <h3>Select a move to replace:</h3>
        
        <div class="move-container">
          <div class="move-grid" id="moveButtonsContainer">
          </div>
        </div>
        
        <button class="cyber-button green-btn" id="confirmMoveBtn" disabled style="opacity: 0.5;">CONFIRM</button>
      </div>
    </div>
  </div>
</div>

<div id="fragmentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title">YOU'RE ON üî• RIGHT MEOW!</h1>
    </div>
    <div class="modal-body">
      <div class="unlock">
        <div class="fragment-progress" style="text-align: center; margin: 30px 0;">
          <h1 id="fragmentCount" style="font-size: 2rem; color: var(--ParticlePink); margin: 20px 0;">1/3 electron states collected!</h1>
          <div class="fragment-icons" style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
            <div class="fragment-icon" id="fragment1" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9090c0; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-family: 'SpaceLetters'; transition: all 0.3s;">üí´</div>
            <div class="fragment-icon" id="fragment2" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9090c0; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-family: 'SpaceLetters'; transition: all 0.3s;">üí´</div>
            <div class="fragment-icon" id="fragment3" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9090c0; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-family: 'SpaceLetters'; transition: all 0.3s;">üí´</div>
          </div>
        </div>
        <button class="cyber-button green-btn" id="continueFragmentBtn">CONTINUE</button>
      </div>
    </div>
  </div>
</div>


<div id="upgradeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title">üí• THAT WAS SUPURRRRR!! üí•</h1>
    </div>
    <div class="modal-body">
      <div class="unlock">
        <h3 id="upgradeInstructions" style="margin-bottom: 10px;">You can meow select a stat to increase by 1 point!</h3>
        <div style="display: flex; gap: 30px; align-items: center; justify-content: center; flex-wrap: wrap;">
          
          <div class="stats-card" style="flex: 0 1 400px; margin: 0;">
            <div class="stats-content">
              <div class="stats-title">CURRENT STATS:</div>
              
              <div class="stat-row" id="attackRow">
                <span class="stat-label">Attack</span>
                <span class="stat-value" id="attackValue">0</span>
              </div>
              
              <div class="stat-row" id="defenseRow">
                <span class="stat-label">Defense</span>
                <span class="stat-value" id="defenseValue">0</span>
              </div>
              
              <div class="stat-row" id="speedRow">
                <span class="stat-label">Speed</span>
                <span class="stat-value" id="speedValue">0</span>
              </div>
            </div>
          </div>

          <div style="flex: 0 1 280px; display: flex; flex-direction: column; gap: 10px;">
            <!-- ATTACK -->
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
              <button class="cyber-button aqua-btn alpha" id="attackDecBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; opacity: 0.3; flex-shrink: 0;" disabled>‚àí</button>
              <div style="text-align: center; min-width: 120px;">
                <strong style="font-family: 'Orbitron', monospace; font-size: 1rem; color: #67FEBD; display: block;">ATTACK</strong>
                <span style="font-size: 1.2rem; color: #dbe2e9;">+<span id="attackIncrease">0</span></span>
              </div>
              <button class="cyber-button aqua-btn alpha" id="attackIncBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; flex-shrink: 0;">+</button>
            </div>

            <!-- DEFENSE -->
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
              <button class="cyber-button pink-btn" id="defenseDecBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; opacity: 0.3; flex-shrink: 0;" disabled>‚àí</button>
              <div style="text-align: center; min-width: 120px;">
                <strong style="font-family: 'Orbitron', monospace; font-size: 1rem; color: #ff69b4; display: block;">DEFENSE</strong>
                <span style="font-size: 1.2rem; color: #dbe2e9; ">+<span id="defenseIncrease">0</span></span>
              </div>
              <button class="cyber-button pink-btn" id="defenseIncBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; flex-shrink: 0;">+</button>
            </div>

            <!-- SPEED -->
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
              <button class="cyber-button purple-btn vortex" id="speedDecBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; opacity: 0.3; flex-shrink: 0;" disabled>‚àí</button>
              <div style="text-align: center; min-width: 120px;">
                <strong style="font-family: 'Orbitron', monospace; font-size: 1rem; color: #A55AFF; display: block;">SPEED</strong>
                <span style="font-size: 1.2rem; color: #dbe2e9; ">+<span id="speedIncrease">0</span></span>
              </div>
              <button class="cyber-button purple-btn vortex" id="speedIncBtn" style="padding: 8px 16px; font-size: 1.2rem; font-weight: bold; flex-shrink: 0;">+</button>
            </div>
          </div>
        </div>

        <div style="font-family: 'GothNerd', sans-serif; font-size: 1.2rem; color: #dbe2e9; text-align: center; margin: 15px 0 20px 0; padding: 5px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 2px solid #9090c0;" id="pointsRemaining">
          Points Remaining: <span style="color: #ff6bff; font-weight: 700; font-size: 1.5rem;" id="pointsValue">1</span>
        </div>
        
        <button class="cyber-button green-btn" id="confirmUpgradeBtn" disabled style="opacity: 0.5;">CONFIRM</button>
      </div>
    </div>
  </div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title">üê± CATastrophe 2</h1>
        <button class="modal-close" id="closeModal">X</button>
      </div>
      <div class="modal-body">
        <blockquote>
          <p><em>"Nature has no reverence towards life. Nature treats life as though it were the most valueless thing in the world....<br>
          Nature does not act by purposes."</em><br>
          <cite>‚Äî Erwin Schr√∂dinger</cite></p>
        </blockquote>         
            <h3> Welcome to Schr√∂dinger's Cat Caf√©! </h3>
            <p>
                The caf√© is in a state of quantum catastrophe ‚Äî simultaneously fine and <em>very much not fine</em>. </p>
                <p>The vibe is off. And the sass levels are dangerously high. </p>
                <p><strong>Your mission:</strong> Stretch your toe beans, sharpen those claws. Grab the catnip. And help the cats collapse the wavefunction in the right direction and save the caf√© from becoming... unalive. </p>
            <h5>üéÆ How to Play</h5>
            <ul>
                <li><strong>Move Left / Right:</strong> Arrow Keys</li>
                <li><strong>Jump:</strong> SPACE</li>
                <li><strong>Pause & Audio Controls:</strong> Top‚Äëleft corner</li>
            </ul>
            <p>
                Your goal in each level is simple: platform your way through the caf√©, cause maximum cup‚Äërelated destruction, avoid (or stomp!) enemies, and reach the Cat Tower to finish the level.
            </p>
            <h5>Platformer Levels</h5>
            <h6> Items </h6>
            <ul>
                <li><strong>Knock Cups Off Platforms:</strong> Just run into them ‚Äî gravity does the rest!</li>
                <li><strong>Fish Bones:</strong> Extra points for your trouble.</li>
                <li><strong>Tuna Cans:</strong> Restores HP. Delicious and nutritious.</li>
                <li><strong>Milk Bottles:</strong> Grants an extra life. Calcium bonus!</li>
                <li><strong>Catnip:</strong> activate <em>zoomies</em> </li>
            </ul>
            <h6> Enemies </h6>
            <ul>
                <li><strong>Falling Cucumbers:</strong> The ancient feline nemesis. Avoid at all costs.</li>
                <li><strong>Lasers:</strong> They‚Äôre not for chasing ‚Äî dodge them!</li>
                <li><strong>Rats:</strong> You can stomp these squeaky foes for extra points.</li>
            </ul>
            <p>
               
            </p>
            <h6>Level Completion</h6>
            <p>
                Reach the <strong>Cat Tower</strong> at the end of each level and leap onto it to finish.  
            </p>
            <h5>‚öîÔ∏è Boss Battles ‚öîÔ∏è</h5>
            <p>
                When you reach a boss, the game shifts into a turn‚Äëbased showdown.  
                Choose your move, then the boss retaliates. Your <strong>Speed</strong> stat determines who acts first ‚Äî because even in quantum combat, fast paws win fights.
            </p>
            <ul>
                <li>Reduce the boss‚Äôs HP to <strong>0</strong> to win the battle.</li>
                <li>Stay strategic ‚Äî your stats matter!</li>
            </ul>


        <p class="mission-text"><strong>Good luck, brave cat warrior!</strong><br>
        The fate of Schr√∂dinger's Cat Caf√© is now in your <em>toe beans</em>! üêæ</p>
      </div>
    </div>
  </div>

<!-- ======================= SCRIPTS =======================-->
<script type="module" src="modules/game.js"></script>   

<script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>
  

 <!-- ===== MODAL CONTROLLER =====-->
<script>
class UpgradeModalController {
  constructor() {
    this.callbacks = {};
    this.tempStats = { attack: 0, defense: 0, speed: 0 };
    this.remainingPoints = 0;
    this.totalPoints = 0; 
    this.selectedMove = null;
    
    this.initializeEventListeners();
  }

  initializeEventListeners() {
    document.getElementById('closeNewMoveModal')?.addEventListener('click', () => this.closeModal('newMoveModal'));
    document.getElementById('closeFragmentModal')?.addEventListener('click', () => this.closeModal('fragmentModal'));
    document.getElementById('closeUpgradeModal')?.addEventListener('click', () => this.closeModal('upgradeModal'));

    document.getElementById('attackIncBtn')?.addEventListener('click', () => this.incrementStat('attack'));
    document.getElementById('defenseIncBtn')?.addEventListener('click', () => this.incrementStat('defense'));
    document.getElementById('speedIncBtn')?.addEventListener('click', () => this.incrementStat('speed'));

    document.getElementById('attackDecBtn')?.addEventListener('click', () => this.decrementStat('attack'));
    document.getElementById('defenseDecBtn')?.addEventListener('click', () => this.decrementStat('defense'));
    document.getElementById('speedDecBtn')?.addEventListener('click', () => this.decrementStat('speed'));

    document.getElementById('confirmUpgradeBtn')?.addEventListener('click', () => this.confirmStatsUpgrade());
    document.getElementById('continueFragmentBtn')?.addEventListener('click', () => this.continueFromFragment());
    document.getElementById('confirmMoveBtn')?.addEventListener('click', () => this.confirmMoveSwap());

    ['newMoveModal', 'fragmentModal', 'upgradeModal'].forEach(modalId => {
      document.getElementById(modalId)?.addEventListener('click', (e) => {
        if (e.target.id === modalId) this.closeModal(modalId);
      });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (document.getElementById('newMoveModal').style.display === 'flex') {
          this.closeModal('newMoveModal');
        } else if (document.getElementById('fragmentModal').style.display === 'flex') {
          this.closeModal('fragmentModal');
        } else if (document.getElementById('upgradeModal').style.display === 'flex') {
          this.closeModal('upgradeModal');
        }
      }
    });
  }

  // ==================== STATS UPGRADE MODAL ====================
  openStatsUpgrade(statPoints, currentStats, onComplete) {
    console.log('üìà Opening stats upgrade modal:', { statPoints, currentStats });
    
    this.totalPoints = statPoints;
    this.remainingPoints = statPoints;
    this.tempStats = { attack: 0, defense: 0, speed: 0 };
    this.baseStats = { ...currentStats }; 
    this.callbacks.statsComplete = onComplete;

    document.getElementById('upgradeInstructions').textContent = 
      `You can meow select a stat to increase by ${statPoints} point${statPoints > 1 ? 's' : ''}!`;
    
    document.getElementById('attackValue').textContent = currentStats.attack || 0;
    document.getElementById('defenseValue').textContent = currentStats.defense || 0;
    document.getElementById('speedValue').textContent = currentStats.speed || 0;
    
    console.log('üìä Displaying current stats:', currentStats);
    
    document.getElementById('pointsValue').textContent = this.remainingPoints;
    document.getElementById('attackIncrease').textContent = 0;
    document.getElementById('defenseIncrease').textContent = 0;
    document.getElementById('speedIncrease').textContent = 0;
    
    this.updateButtonStates();
    
    const confirmBtn = document.getElementById('confirmUpgradeBtn');
    confirmBtn.disabled = true;
    confirmBtn.style.opacity = '0.5';

    this.showModal('upgradeModal');
  }

  incrementStat(stat) {
    if (this.remainingPoints <= 0) return;

    this.tempStats[stat]++;
    this.remainingPoints--;

    this.updateStatDisplay(stat);
    this.updateButtonStates();

    if (window.play) window.play("collectCup", { volume: 0.2 });
  }

  decrementStat(stat) {
    if (this.tempStats[stat] <= 0) return;

    this.tempStats[stat]--;
    this.remainingPoints++;

    this.updateStatDisplay(stat);
    this.updateButtonStates();

    if (window.play) window.play("happyMeow", { volume: 0.15 });
  }

  updateStatDisplay(stat) {
    document.getElementById(`${stat}Increase`).textContent = this.tempStats[stat];
    
    document.getElementById('pointsValue').textContent = this.remainingPoints;

    const statMultiplier = 1;
    const newStatValue = this.baseStats[stat] + (this.tempStats[stat] * statMultiplier);
    document.getElementById(`${stat}Value`).textContent = newStatValue;

    const row = document.getElementById(`${stat}Row`);
    row.classList.add('increase');
    setTimeout(() => row.classList.remove('increase'), 500);
  }

  updateButtonStates() {
    const canIncrement = this.remainingPoints > 0;
    ['attack', 'defense', 'speed'].forEach(stat => {
      const incBtn = document.getElementById(`${stat}IncBtn`);
      if (incBtn) {
        incBtn.disabled = !canIncrement;
        incBtn.style.opacity = canIncrement ? '1' : '0.3';
        incBtn.style.cursor = canIncrement ? 'pointer' : 'not-allowed';
      }
    });

    ['attack', 'defense', 'speed'].forEach(stat => {
      const decBtn = document.getElementById(`${stat}DecBtn`);
      const canDecrement = this.tempStats[stat] > 0;
      if (decBtn) {
        decBtn.disabled = !canDecrement;
        decBtn.style.opacity = canDecrement ? '1' : '0.3';
        decBtn.style.cursor = canDecrement ? 'pointer' : 'not-allowed';
      }
    });

    const confirmBtn = document.getElementById('confirmUpgradeBtn');
    if (this.remainingPoints === 0) {
      confirmBtn.disabled = false;
      confirmBtn.style.opacity = '1';
    } else {
      confirmBtn.disabled = true;
      confirmBtn.style.opacity = '0.5';
    }
  }

  confirmStatsUpgrade() {
    if (this.remainingPoints !== 0) return;

    console.log('‚úÖ Stats upgrade confirmed:', this.tempStats);
    
    if (window.play) window.play("powerUp", { volume: 0.4 });
    
    this.closeModal('upgradeModal');
    
    setTimeout(() => {
      const canvas = document.querySelector('canvas');
      if (canvas) {
        canvas.focus();
        console.log('‚úÖ Canvas refocused after stats upgrade');
      }
    }, 100);
    
    if (this.callbacks.statsComplete) {
      this.callbacks.statsComplete(this.tempStats);
    }
  }

  // ==================== FRAGMENT COLLECTION MODAL ====================
  openFragmentCollection(fragmentsCollected, onComplete) {
    console.log('‚ú® Opening fragment collection modal:', fragmentsCollected);
    
    this.callbacks.fragmentComplete = onComplete;

    document.getElementById('fragmentCount').textContent = `${fragmentsCollected}/3 fragments obtained`;
    
    for (let i = 1; i <= 3; i++) {
      const fragment = document.getElementById(`fragment${i}`);
      if (i <= fragmentsCollected) {
        setTimeout(() => {
          fragment.classList.add('collected');
        }, i * 200); 
      } else {
        fragment.classList.remove('collected');
      }
    }

    this.showModal('fragmentModal');
  }

  continueFromFragment() {
    if (window.play) window.play("powerUp", { volume: 0.4 });
    
    this.closeModal('fragmentModal');
    
    setTimeout(() => {
      const canvas = document.querySelector('canvas');
      if (canvas) {
        canvas.focus();
        console.log('‚úÖ Canvas refocused after fragment collection');
      }
    }, 100);
    
    if (this.callbacks.fragmentComplete) {
      this.callbacks.fragmentComplete();
    }
  }

  // ==================== NEW MOVE MODAL ====================
  openMoveSelection(moveName, moveStats, moveImage, currentMoves, onComplete) {
    console.log('üéØ Opening move selection modal:', { moveName, currentMoves });
    
    this.selectedMove = null;
    this.callbacks.moveComplete = onComplete;

    document.getElementById('moveName').textContent = moveName;
    document.getElementById('moveStats').textContent = moveStats;
    document.getElementById('moveImage').src = moveImage;
    
    const container = document.getElementById('moveButtonsContainer');
    container.innerHTML = '';
    
    Object.entries(currentMoves).forEach(([name, move]) => {
      const btn = document.createElement('button');
      btn.className = 'cyber-button grey-btn cool';
      btn.innerHTML = `<strong>${name}</strong><br>${move.dmg ? `DMG: ${move.dmg}` : `HEAL: ${move.heal}`}`;
      
      btn.addEventListener('click', () => {
        container.querySelectorAll('.cyber-button').forEach(b => b.classList.remove('selected'));
        
        btn.classList.add('selected');
        this.selectedMove = name;
        
        const confirmBtn = document.getElementById('confirmMoveBtn');
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
        
        if (window.play) window.play("happyMeow", { volume: 0.2 });
      });
      
      container.appendChild(btn);
    });

    const confirmBtn = document.getElementById('confirmMoveBtn');
    confirmBtn.disabled = true;
    confirmBtn.style.opacity = '0.5';

    this.showModal('newMoveModal');
  }

  confirmMoveSwap() {
    if (!this.selectedMove) return;

    console.log('‚úÖ Move swap confirmed:', this.selectedMove);
    
    if (window.play) window.play("powerUp", { volume: 0.4 });
    
    this.closeModal('newMoveModal');
    
    setTimeout(() => {
      const canvas = document.querySelector('canvas');
      if (canvas) {
        canvas.focus();
        console.log('‚úÖ Canvas refocused after move swap');
      }
    }, 100);
    
    if (this.callbacks.moveComplete) {
      this.callbacks.moveComplete(this.selectedMove);
    }
  }

  // ==================== UTILITY METHODS ====================
  showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
  }

  closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  }
}

window.upgradeModalController = new UpgradeModalController();

window.openStatsUpgradeModal = (statPoints, currentStats, onComplete) => {
  window.upgradeModalController.openStatsUpgrade(statPoints, currentStats, onComplete);
};

window.openFragmentCollectionModal = (fragmentsCollected, onComplete) => {
  window.upgradeModalController.openFragmentCollection(fragmentsCollected, onComplete);
};

window.openMoveSelectionModal = (moveName, moveStats, moveImage, currentMoves, onComplete) => {
  window.upgradeModalController.openMoveSelection(moveName, moveStats, moveImage, currentMoves, onComplete);
};

console.log('üéÆ Upgrade Modal Controller initialized!');
</script>

</body>
</html>