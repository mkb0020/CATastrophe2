<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="stylesheet" href="/assets/css/basic.css">
  <link rel="stylesheet" href="/assets/css/modals.css">
  <link rel="stylesheet" href="/assets/css/nav.css">
  <link rel="stylesheet" href="/assets/css/dreamy.css">
  <link rel="stylesheet" href="/assets/css/canvas.css">
  <link rel="stylesheet" href="/assets/css/HUD.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <script type="importmap">
    {
      "imports": {
        "kaplay": "https://cdn.skypack.dev/kaplay"
      }
    }
  </script>
  <title>CATastrophe2</title>
</head>

<body>
<!-- ======================= BACKGROUND =======================-->
<div id="stars"></div>
<div class="dreamy-overlay"></div>

<div class="content-wrapper">
  <div class="background-gradient"></div>
  <div class="waves">
       <svg id="wave1" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,350 Q500,150 1000,350 T2000,350 T3000,350 L3000,600 L0,600 Z" fill="#4b0082" opacity="0.9"/>
        </svg>
        <svg id="wave2" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,380 Q500,200 1000,380 T2000,380 T3000,380 L3000,600 L0,600 Z" fill="#c71585" opacity="0.8"/>
        </svg>
        <!--<svg id="wave3" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,400 Q333,200 666,400 T1333,400 T2000,400 T2333,400 T2666,400 T3000,400 L3000,600 L0,600 Z" fill="#ff69b4" opacity="0.75"/>
        </svg>
        <svg id="wave4" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,420 Q750,250 1500,420 T3000,420 L3000,600 L0,600 Z" fill="#db7093" opacity="0.7"/>
        </svg>--->
        <svg id="wave5" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,300 Q250,150 500,300 T1000,300 T1500,300 T2000,300 T2500,300 T3000,300 L3000,600 L0,600 Z" fill="#ff69b4" opacity="0.5"/>
        </svg>
        <!--<svg id="wave6" viewBox="0 0 3000 600" preserveAspectRatio="none">
          <path d="M0,250 Q600,100 1200,250 T2400,250 L3000,250 L3000,600 L0,600 Z" fill="#e066ff" opacity="0.4"/>
        </svg>-->
  </div>

<!-- ======================= NAV =======================-->
  <nav class="navbar">
      <div class="nav-container">
        
        <div class="left-dropdown"><!-- LEFT DROPDOWN MENU -->
          <button class="menu-trigger" aria-label="Menu">
            <img src="/assets/images/Niels2.png" alt="Menu" class="home-icon">
          </button>

          <div class="left-menu">
            <a href="https://mkb0020.vercel.app/" class="menu-item">Home</a>
            <a href="https://mkb0020.github.io/" class="menu-item">Javascript Projects</a>
            <a href="https://mkb0020.github.io/Toolkit.html" class="menu-item">Schr√∂dinger's Toolbox</a>
            <a href="https://mkb0020.onrender.com/resume" class="menu-item">Resume</a>
            <!--<a href="https://mkb0020.onrender.com/contact" class="menu-item">Contact</a>-->
            <a href="https://mkb0020.vercel.app/comments" class="menu-item">Guestbook</a>
            <a href="https://mkb0020.vercel.app/game-testing" class="menu-item">CATastrophe 2 Feedback</a>

            <div class="social-links">
              <a href="https://www.youtube.com/@mkb0020" target="_blank" aria-label="YouTube">
                <img src="/assets/images/icons/youtube-icon.png" alt="YouTube" class="social-icon">
              </a>
            
              <a href="https://www.linkedin.com/in/mkb0020/" target="_blank" aria-label="LinkedIn">
                <img src="/assets/images/icons/linkedin-icon.png" alt="LinkedIn" class="social-icon">
              </a>

              <a href="https://mkb0020.github.io/MKLambda.html" target="_blank" aria-label="Github">
                <img src="/assets/images/icons/music-icon.png" alt="Github" class="social-icon">
              </a>

              <a href="https://github.com/mkb0020" target="_blank" aria-label="GitHub">
                <img src="/assets/images/icons/github-icon.png" alt="GitHub" class="social-icon">
              </a>

              <a href="https://mkb0020.itch.io" target="_blank" aria-label="Itch.io">
                <img src="/assets/images/icons/itchio-icon.png" alt="Itch.io" class="social-icon">
              </a>
            </div>
          </div>
        </div>
<div class="hud-stats-inner">
      <div class="stat-divider">
                |
        </div>
      <div class="stat-item stat-score">
        <span id="scoreText">Score: --</span>
      </div>
      <div class="stat-divider">
                |
      </div>
      <div class="stat-item stat-hp" id="hpStat">
        <span id="hpText">HP: --</span>
      </div>
      <div class="stat-divider">
                |
      </div>
      <div class="stat-item stat-title">
              üê± CATastrophe2 üê±  <!-- CENTER LOGO -->
      </div>
      <div class="stat-divider">
                |
      </div>
      <div class="stat-item stat-lives">
        <span id="livesText">Lives: --</span>
      </div>
      <div class="stat-divider">
                |
      </div>
      <div class="stat-item stat-time" id="timeStat">
        <span id="timeText">Time: --</span>
      </div>
      <div class="stat-divider">
                |
      </div>

</div>
      <div class="help-dropdown">
        <button class="help-icon" id="helpBtn"><div class="question-mark">?</div></button>
        <div class="dropdown-menu">
          <button id="openHelp">About This Player</button>
        </div>
      </div>
    </div>
  </nav>

<!-- ======================= CANVAS =======================-->

<div class="hero-content">
      <div class="canvas-container">
        <!--<div class="parallax-bg"></div>-->
        <canvas id="gameCanvas" width="1000" height="480"></canvas>
      </div>
</div>

<div id="game-controls">
            <button id="volume-btn" class="control-btn" data-tooltip="TURN MUSIC OFF/ON">
                üîä
            </button>
            <button id="pause-btn" class="control-btn" data-tooltip="PAUSE LEVEL">
                <div class="pause-icon">
                    <div class="pause-bar"></div>
                    <div class="pause-bar"></div>
                </div>
            </button>
        </div>
</div>

<div class="debug-toggle" id="debugToggle" title="Toggle Debug Info">
    <img src="assets/images/settings.png" alt="Settings">
</div>

<div class="debug-info" id="debugInfo" style="display: none;">
    X: 0  Y: 0
</div>
</div>

<!-- ======================= MODAlS =======================-->
  <div id="howToPlayModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title">THAT WAS SUPURRRRR!!</h1>
        <button class="modal-close" id="closeUpgradeModal">X</button>
      </div>
      <div class="modal-body" style="align-items: center; justify-content: center; text-align: center;">
        <div class="unlock">
          <h3>You can meow select a stat to increase by 1 point!</h3>

          <div class="stats-card">
            <div class="stats-content">
              <div class="stats-title">CURRENT STATS:</div>
              
              <div class="stat-row">
                <span class="stat-label">Attack</span>
                <span class="stat-value">30</span>
              </div>
              
              <div class="stat-row">
                <span class="stat-label">Damage</span>
                <span class="stat-value">30</span>
              </div>
              
              <div class="stat-row">
                <span class="stat-label">Speed</span>
                <span class="stat-value">30</span>
              </div>
            </div>
          </div>

            <div class="move-container">
              <div class="move-grid">
                    <button class="cyber-button aqua-btn"><strong>ATTACK</strong></button>
                    <button class="cyber-button pink-btn"><strong>DEFENSE</strong></button>
                    <button class="cyber-button purple-btn vortex"><strong>SPEED</strong></button>
              </div>
            </div>
        <button class="cyber-button green-btn">CONTINUE</button>
      </div>
      </div>


    </div>
  </div>

<div id="aboutCatsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title">MEET THE CATS</h1>
        <button class="modal-close" id="closeCatsModal">X</button>
      </div>
      <div class="modal-body">
        <div class="cat-grid">
          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Nona.png" alt="Nona">
                <h3>NONA</h3>
              </div>
              <div class="cat-card-back">
                <h3>NONA</h3>
                <p>PLACEHOLDER ‚ô•</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Gato.png" alt="Gato">
                <h3>GATO</h3>
              </div>
              <div class="cat-card-back">
                <h3>GATO</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Nova.png" alt="Nova">
                <h3>NOVA</h3>
              </div>
              <div class="cat-card-back">
                <h3>NOVA</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Niels.png" alt="Niels">
                <h3>NIELS</h3>
              </div>
              <div class="cat-card-back">
                <h3>NIELS</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Aubie.png" alt="Aubie">
                <h3>AUBIE</h3>
              </div>
              <div class="cat-card-back">
                <h3>AUBIE</h3>
                <p>PLACEHOLDER. War Eagle! ü¶Ö</p>
              </div>
            </div>
          </div>

          <div class="cat-card">
            <div class="cat-card-inner">
              <div class="cat-card-front">
                <img src="/assets/images/portraits/Doug.png" alt="Doug">
                <h3>DOUG</h3>
              </div>
              <div class="cat-card-back">
                <h3>DOUG</h3>
                <p>PLACEHOLDER</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<div id="newMoveModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title">NEW BATTLE MOVE UNLOCKED!</h1>
      <button class="modal-close" id="closeNewMoveModal">X</button>
    </div>
    <div class="modal-body">
      <div class="unlock">
        <h1 id="moveName">WHISKER WHIP!</h1>
        <h2 id="moveStats">(DMG: 40, Uses: 2)</h2>
        <img id="moveImage" src="/assets/images/items/whiskerWhip.PNG" alt="WHISKER WHIP" style="display: block; margin: 20px auto; max-width: 200px; filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));">
        <h3>Select a move to replace:</h3>
        
        <div class="move-container">
          <div class="move-grid" id="moveButtonsContainer">
          </div>
        </div>
        
        <button class="cyber-button green-btn" id="confirmMoveBtn" disabled style="opacity: 0.5;">CONFIRM</button>
      </div>
    </div>
  </div>
</div>

<div id="fragmentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title">PURRRRRfect!</h1>
      <button class="modal-close" id="closeFragmentModal">√ó</button>
    </div>
    <div class="modal-body">
      <div class="unlock">
        <div class="fragment-progress" style="text-align: center; margin: 30px 0;">
          <h1 id="fragmentCount" style="font-size: 2rem; color: #58e84c; margin: 20px 0; text-shadow: 0 0 15px rgba(88, 232, 76, 0.6);">1/3 fragments obtained</h1>
          <div class="fragment-icons" style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
            <div class="fragment-icon" id="fragment1" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9090c0; display: flex; align-items: center; justify-content: center; font-size: 2rem; transition: all 0.3s;">‚ú¶</div>
            <div class="fragment-icon" id="fragment2" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9090c0; display: flex; align-items: center; justify-content: center; font-size: 2rem; transition: all 0.3s;">‚ú¶</div>
            <div class="fragment-icon" id="fragment3" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9090c0; display: flex; align-items: center; justify-content: center; font-size: 2rem; transition: all 0.3s;">‚ú¶</div>
          </div>
          <h3>Keep going to unlock a new battle move!</h3>
        </div>
        <button class="cyber-button green-btn" id="continueFragmentBtn">CONTINUE</button>
      </div>
    </div>
  </div>
</div>

<div id="upgradeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title">THAT WAS SUPURRRRR!!</h1>
      <button class="modal-close" id="closeUpgradeModal">X</button>
    </div>
    <div class="modal-body">
      <div class="unlock">
        <h3 id="upgradeInstructions">You can meow select a stat to increase by 1 point!</h3>

        <div class="stats-card">
          <div class="stats-content">
            <div class="stats-title">CURRENT STATS:</div>
            
            <div class="stat-row" id="attackRow">
              <span class="stat-label">Attack</span>
              <span class="stat-value" id="attackValue">0</span>
            </div>
            
            <div class="stat-row" id="defenseRow">
              <span class="stat-label">Defense</span>
              <span class="stat-value" id="defenseValue">0</span>
            </div>
            
            <div class="stat-row" id="speedRow">
              <span class="stat-label">Speed</span>
              <span class="stat-value" id="speedValue">0</span>
            </div>
          </div>
        </div>

        <div style="font-family: 'GothNerd', sans-serif; font-size: 1.3rem; color: #dbe2e9; text-align: center; margin: 20px 0; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 2px solid #9090c0;" id="pointsRemaining">
          Points Remaining: <span style="color: #ff6bff; font-weight: 700; font-size: 1.5rem;" id="pointsValue">1</span>
        </div>

        <div class="move-container">
          <div class="move-grid">
            <button class="cyber-button aqua-btn alpha" id="attackBtn">
              <strong>ATTACK</strong><br>+<span id="attackIncrease">0</span>
            </button>
            <button class="cyber-button pink-btn" id="defenseBtn">
              <strong>DEFENSE</strong><br>+<span id="defenseIncrease">0</span>
            </button>
            <button class="cyber-button purple-btn vortex" id="speedBtn">
              <strong>SPEED</strong><br>+<span id="speedIncrease">0</span>
            </button>
          </div>
        </div>
        
        <button class="cyber-button green-btn" id="confirmUpgradeBtn" disabled style="opacity: 0.5;">CONFIRM</button>
      </div>
    </div>
  </div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title">üê± CATastrophe 2</h1>
        <button class="modal-close" id="closeModal">X</button>
      </div>
      <div class="modal-body">
        <blockquote>
          <p><em>"Nature has no reverence towards life. Nature treats life as though it were the most valueless thing in the world....<br>
          Nature does not act by purposes."</em><br>
          <cite>‚Äî Erwin Schr√∂dinger</cite></p>
        </blockquote>         
            <h3> Welcome to Schr√∂dinger's Cat Caf√©! </h3>
            <p>
                The caf√© is in a state of quantum catastrophe ‚Äî simultaneously fine and <em>very much not fine</em>. </p>
                <p>The vibe is off. And the sass levels are dangerously high. </p>
                <p><strong>Your mission:</strong> Stretch your toe beans, sharpen those claws. Grab the catnip. And help the cats collapse the wavefunction in the right direction and save the caf√© from becoming... unalive. </p>
            <h5>üéÆ How to Play</h5>
            <ul>
                <li><strong>Move Left / Right:</strong> Arrow Keys</li>
                <li><strong>Jump:</strong> SPACE</li>
                <li><strong>Pause & Audio Controls:</strong> Top‚Äëleft corner</li>
            </ul>
            <p>
                Your goal in each level is simple: platform your way through the caf√©, cause maximum cup‚Äërelated destruction, avoid (or stomp!) enemies, and reach the Cat Tower to finish the level.
            </p>
            <h5>Platformer Levels</h5>
            <h6> Items </h6>
            <ul>
                <li><strong>Knock Cups Off Platforms:</strong> Just run into them ‚Äî gravity does the rest!</li>
                <li><strong>Fish Bones:</strong> Extra points for your trouble.</li>
                <li><strong>Tuna Cans:</strong> Restores HP. Delicious and nutritious.</li>
                <li><strong>Milk Bottles:</strong> Grants an extra life. Calcium bonus!</li>
                <li><strong>Catnip:</strong> activate <em>zoomies</em> </li>
            </ul>
            <h6> Enemies </h6>
            <ul>
                <li><strong>Falling Cucumbers:</strong> The ancient feline nemesis. Avoid at all costs.</li>
                <li><strong>Lasers:</strong> They‚Äôre not for chasing ‚Äî dodge them!</li>
                <li><strong>Rats:</strong> You can stomp these squeaky foes for extra points.</li>
            </ul>
            <p>
               
            </p>
            <h6>Level Completion</h6>
            <p>
                Reach the <strong>Cat Tower</strong> at the end of each level and leap onto it to finish.  
            </p>
            <h5>‚öîÔ∏è Boss Battles ‚öîÔ∏è</h5>
            <p>
                When you reach a boss, the game shifts into a turn‚Äëbased showdown.  
                Choose your move, then the boss retaliates. Your <strong>Speed</strong> stat determines who acts first ‚Äî because even in quantum combat, fast paws win fights.
            </p>
            <ul>
                <li>Reduce the boss‚Äôs HP to <strong>0</strong> to win the battle.</li>
                <li>Stay strategic ‚Äî your stats matter!</li>
            </ul>
            <!--<h5>üîÆ Secrets & Collectibles</h5>
            <ul>
                <li><strong>The Three Neko States:</strong> Collect all three to unlock a special thing!</li>
            </ul>-->

        <p class="mission-text"><strong>Good luck, brave cat warrior!</strong><br>
        The fate of Schr√∂dinger's Cat Caf√© is now in your <em>toe beans</em>! üêæ</p>
      </div>
    </div>
  </div>

<!-- ======================= SCRIPTS =======================-->

  <script type="module" src="modules/game.js"></script>   

  <script>
    let gameState = {
      score: 0,
      hp: 120,
      maxHP: 120,
      lives: 3,
      timeLeft: 90,
      playerX: 0,
      playerY: 0
    };
    const scoreText = document.getElementById('scoreText');
    const hpText = document.getElementById('hpText');
    const hpStat = document.getElementById('hpStat');
    const livesText = document.getElementById('livesText');
    const timeText = document.getElementById('timeText');
    const timeStat = document.getElementById('timeStat');

    const debugToggle = document.getElementById('debugToggle');
    const debugInfo = document.getElementById('debugInfo');
    let debugVisible = false;

    debugToggle.addEventListener('click', () => {
      debugVisible = !debugVisible;
      debugInfo.style.display = debugVisible ? 'block' : 'none';
      
      if (debugVisible) {
        debugToggle.style.background = 'var(--AquaAura)';
        debugToggle.style.boxShadow = '0 0 20px var(--AquaAura)';
      } else {
        debugToggle.style.background = 'rgba(0, 0, 0, 0.8)';
        debugToggle.style.boxShadow = 'none';
      }
    });


  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const helpBtn = document.getElementById('helpBtn');
      const modal = document.getElementById('helpModal');
      const closeBtn = document.getElementById('closeModal');

      helpBtn.addEventListener('click', () => {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; 
      });

    
      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
          document.body.style.overflow = 'auto';
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
          modal.style.display = 'none';
          document.body.style.overflow = 'auto';
        }
      });
    });
  </script>
  <script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>
  
<script type="module">
  import { initializeModals } from './modules/helpers/kittyHelpers.js';
  initializeModals();
</script>

  <script>
        const starsDiv = document.getElementById('stars');
        for (let i = 0; i < 200; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.width = star.style.height = Math.random() * 2 + 'px';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 4 + 's';
            starsDiv.appendChild(star);
        }
  </script>

<script>
        
        const volumeBtn = document.getElementById('volume-btn'); // MUSIC BUTTON
        let isMuted = false;

        volumeBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            volumeBtn.textContent = isMuted ? 'üîá' : 'üîä';
            volumeBtn.classList.toggle('muted', isMuted);
            
            if (window.menuMusic) window.menuMusic.volume = isMuted ? 0 : 0.5;
            if (window.levelMusic) window.levelMusic.volume = isMuted ? 0 : 0.4;
            if (window.bossMusic) window.bossMusic.volume = isMuted ? 0 : 0.4;
            if (window.finalBossMusic) window.finalBossMusic.volume = isMuted ? 0 : 0.5;
            if (window.gameOverMusic) window.gameOverMusic.volume = isMuted ? 0 : 0.4;
            if (window.victoryMusic) window.victoryMusic.volume = isMuted ? 0 : 0.5;
            
            console.log(`üîá Volume ${isMuted ? 'MUTED' : 'UNMUTED'}`);
        });

        const pauseBtn = document.getElementById('pause-btn');
        
        pauseBtn.addEventListener('click', () => {
            if (window.gamePauseSystem) {
                window.gamePauseSystem.pause();
            }
        });

        window.isMuted = isMuted;
        window.toggleMute = () => volumeBtn.click();
    </script>

<script>
  // ==================== MODAL CONTROLLER ====================
  class UpgradeModalController {
    constructor() {
      this.callbacks = {};
      this.tempStats = { attack: 0, defense: 0, speed: 0 };
      this.remainingPoints = 0;
      this.selectedMove = null;
      
      this.initializeEventListeners();
    }

    initializeEventListeners() {
      document.getElementById('closeNewMoveModal')?.addEventListener('click', () => this.closeModal('newMoveModal'));
      document.getElementById('closeFragmentModal')?.addEventListener('click', () => this.closeModal('fragmentModal'));
      document.getElementById('closeUpgradeModal')?.addEventListener('click', () => this.closeModal('upgradeModal'));

      document.getElementById('attackBtn')?.addEventListener('click', () => this.incrementStat('attack'));
      document.getElementById('defenseBtn')?.addEventListener('click', () => this.incrementStat('defense'));
      document.getElementById('speedBtn')?.addEventListener('click', () => this.incrementStat('speed'));
      document.getElementById('confirmUpgradeBtn')?.addEventListener('click', () => this.confirmStatsUpgrade());

      document.getElementById('continueFragmentBtn')?.addEventListener('click', () => this.continueFromFragment());

      document.getElementById('confirmMoveBtn')?.addEventListener('click', () => this.confirmMoveSwap());

      ['newMoveModal', 'fragmentModal', 'upgradeModal'].forEach(modalId => {
        document.getElementById(modalId)?.addEventListener('click', (e) => {
          if (e.target.id === modalId) this.closeModal(modalId);
        });
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (document.getElementById('newMoveModal').style.display === 'flex') {
            this.closeModal('newMoveModal');
          } else if (document.getElementById('fragmentModal').style.display === 'flex') {
            this.closeModal('fragmentModal');
          } else if (document.getElementById('upgradeModal').style.display === 'flex') {
            this.closeModal('upgradeModal');
          }
        }
      });
    }

    // ==================== STATS UPGRADE MODAL ====================
    openStatsUpgrade(statPoints, currentStats, onComplete) {
      console.log('üìà Opening stats upgrade modal:', { statPoints, currentStats });
      
      this.remainingPoints = statPoints;
      this.tempStats = { attack: 0, defense: 0, speed: 0 };
      this.baseStats = { ...currentStats }; 
      this.callbacks.statsComplete = onComplete;

      document.getElementById('upgradeInstructions').textContent = 
        `You can meow select a stat to increase by ${statPoints} point${statPoints > 1 ? 's' : ''}!`;
      
      document.getElementById('attackValue').textContent = currentStats.attack || 0;
      document.getElementById('defenseValue').textContent = currentStats.defense || 0;
      document.getElementById('speedValue').textContent = currentStats.speed || 0;
      
      console.log('üìä Displaying current stats:', currentStats);
      
      document.getElementById('pointsValue').textContent = this.remainingPoints;
      document.getElementById('attackIncrease').textContent = 0;
      document.getElementById('defenseIncrease').textContent = 0;
      document.getElementById('speedIncrease').textContent = 0;
      
      const confirmBtn = document.getElementById('confirmUpgradeBtn');
      confirmBtn.disabled = true;
      confirmBtn.style.opacity = '0.5';

      this.showModal('upgradeModal');
    }

    incrementStat(stat) {
      if (this.remainingPoints <= 0) return;

      this.tempStats[stat]++;
      this.remainingPoints--;

      document.getElementById(`${stat}Increase`).textContent = this.tempStats[stat];
      document.getElementById('pointsValue').textContent = this.remainingPoints;

      const statMultiplier = stat === 'speed' ? 10 : 5;
      const newStatValue = this.baseStats[stat] + (this.tempStats[stat] * statMultiplier);
      document.getElementById(`${stat}Value`).textContent = newStatValue;

      const row = document.getElementById(`${stat}Row`);
      row.classList.add('increase');
      setTimeout(() => row.classList.remove('increase'), 500);

      const confirmBtn = document.getElementById('confirmUpgradeBtn');
      if (this.remainingPoints === 0) {
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
      }

      if (window.play) window.play("collectCup", { volume: 0.2 }); // PLACEHOLDER
    }

    confirmStatsUpgrade() {
      if (this.remainingPoints !== 0) return;

      console.log('‚úÖ Stats upgrade confirmed:', this.tempStats);
      
      if (window.play) window.play("powerUp", { volume: 0.4 });
      
      this.closeModal('upgradeModal');
      
      setTimeout(() => {
        const canvas = document.querySelector('canvas');
        if (canvas) {
          canvas.focus();
          console.log('‚úÖ Canvas refocused after stats upgrade');
        }
      }, 100);
      
      if (this.callbacks.statsComplete) {
        this.callbacks.statsComplete(this.tempStats);
      }
    }

    // ==================== FRAGMENT COLLECTION MODAL ====================
    openFragmentCollection(fragmentsCollected, onComplete) {
      console.log('‚ú® Opening fragment collection modal:', fragmentsCollected);
      
      this.callbacks.fragmentComplete = onComplete;

      document.getElementById('fragmentCount').textContent = `${fragmentsCollected}/3 fragments obtained`;
      
      for (let i = 1; i <= 3; i++) {
        const fragment = document.getElementById(`fragment${i}`);
        if (i <= fragmentsCollected) {
          setTimeout(() => {
            fragment.classList.add('collected');
          }, i * 200); 
        } else {
          fragment.classList.remove('collected');
        }
      }

      this.showModal('fragmentModal');
    }

    continueFromFragment() {
      if (window.play) window.play("powerUp", { volume: 0.4 });
      
      this.closeModal('fragmentModal');
      
      setTimeout(() => {
        const canvas = document.querySelector('canvas');
        if (canvas) {
          canvas.focus();
          console.log('‚úÖ Canvas refocused after fragment collection');
        }
      }, 100);
      
      if (this.callbacks.fragmentComplete) {
        this.callbacks.fragmentComplete();
      }
    }

    // ==================== NEW MOVE MODAL ====================
    openMoveSelection(moveName, moveStats, moveImage, currentMoves, onComplete) {
      console.log('üéØ Opening move selection modal:', { moveName, currentMoves });
      
      this.selectedMove = null;
      this.callbacks.moveComplete = onComplete;

      document.getElementById('moveName').textContent = moveName;
      document.getElementById('moveStats').textContent = moveStats;
      document.getElementById('moveImage').src = moveImage;
      
      const container = document.getElementById('moveButtonsContainer');
      container.innerHTML = '';
      
      Object.entries(currentMoves).forEach(([name, move]) => {
        const btn = document.createElement('button');
        btn.className = 'cyber-button grey-btn cool';
        btn.innerHTML = `<strong>${name}</strong><br>${move.dmg ? `DMG: ${move.dmg}` : `HEAL: ${move.heal}`}`;
        
        btn.addEventListener('click', () => {
          container.querySelectorAll('.cyber-button').forEach(b => b.classList.remove('selected'));
          
          btn.classList.add('selected');
          this.selectedMove = name;
          
          const confirmBtn = document.getElementById('confirmMoveBtn');
          confirmBtn.disabled = false;
          confirmBtn.style.opacity = '1';
          
          if (window.play) window.play("collectCup", { volume: 0.2 });
        });
        
        container.appendChild(btn);
      });

      const confirmBtn = document.getElementById('confirmMoveBtn');
      confirmBtn.disabled = true;
      confirmBtn.style.opacity = '0.5';

      this.showModal('newMoveModal');
    }

    confirmMoveSwap() {
      if (!this.selectedMove) return;

      console.log('‚úÖ Move swap confirmed:', this.selectedMove);
      
      if (window.play) window.play("powerUp", { volume: 0.4 });
      
      this.closeModal('newMoveModal');
      
      setTimeout(() => {
        const canvas = document.querySelector('canvas');
        if (canvas) {
          canvas.focus();
          console.log('‚úÖ Canvas refocused after move swap');
        }
      }, 100);
      
      if (this.callbacks.moveComplete) {
        this.callbacks.moveComplete(this.selectedMove);
      }
    }

    // ==================== UTILITY METHODS ====================
    showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }
  }

  window.upgradeModalController = new UpgradeModalController();

  window.openStatsUpgradeModal = (statPoints, currentStats, onComplete) => {
    window.upgradeModalController.openStatsUpgrade(statPoints, currentStats, onComplete);
  };

  window.openFragmentCollectionModal = (fragmentsCollected, onComplete) => {
    window.upgradeModalController.openFragmentCollection(fragmentsCollected, onComplete);
  };

  window.openMoveSelectionModal = (moveName, moveStats, moveImage, currentMoves, onComplete) => {
    window.upgradeModalController.openMoveSelection(moveName, moveStats, moveImage, currentMoves, onComplete);
  };

  console.log('üéÆ Upgrade Modal Controller initialized!');
</script>

</body>
</html>